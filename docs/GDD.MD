# Dungeons and Blocks – Game Design Document

_Last updated: 2025-10-13_

This document describes the current Phaser/TypeScript prototype and the target experience as we take the project fully on-chain. It aligns with the implemented Town → Embark → Dungeon → Combat flow while introducing the dungeon-NFT economy and multi-portal escape mechanic requested for the next milestone.

---

## 1. High-Concept Overview

**Elevator pitch** – Lead a band of NFT heroes from a living town into player-authored dungeons that run on-chain. Torchlight, stress, and permadeath keep every step tense. Survive to bank your haul; fail and your heroes’ souls (and their NFTs) are gone forever. Dungeon architects mint their layouts as NFTs and earn a cut of the treasure other players manage to extract.

- **Genre:** Single-player roguelike dungeon crawler with light management and tactical combat.
- **Camera & tech:** Top-down 2D, Phaser 3 + TypeScript, Vite bundle.
- **Platform goal:** Web client with wallet connection; execution and settlement on Solana (or L2) using programmatic rollups for real-time steps.
- **Player fantasy:** Manage a roster in town, chart and survive deadly procedural dungeons, invest in better layouts, and profit from other delvers if they succeed inside your halls.

---

## 2. Current Prototype Loop

```
Town (roster, facilities, embark CTA)
        │
        ▼
Embark Planner (select/create dungeon, choose party & supplies)
        │
        ▼
Dungeon Exploration (`Game` scene)
  ├─ Torch / stress / minimap / chests
  ├─ Random encounter prompt → Combat scene
  ├─ Loot modal & run inventory
  └─ (Future) Portals for extraction
        │
        ▼
Combat (turn-based, 4v4 lanes, loot & stress updates)
        │
        └──▶ Return to Town (run summary, stress carryover, inventory sync)
```

- All scenes already exist in code and share state via lightweight stores (`townStore`, `RunState`, inventory snapshots).
- UI widgets (stress meter, run inventory, encounter prompt, minimap) are layered with separate cameras for world vs HUD.
- Loot chests appear in random dungeon tiles; interacting triggers loot modal and minimap markers.

---

## 3. Scene Breakdown

### 3.1 Town (`TownScene.ts`)

- Establishes the hub experience: roster panel (scrollable with drag + wheel), building grid, toast notifications, pause overlay.
- Buildings currently trigger placeholder actions but are ready to wire to on-chain transactions (ABBey stress relief, market purchases, etc.).
- Embark CTA launches the planner (E key shortcut). Inventory UI is hidden while in town to avoid overlap with town HUD.

### 3.2 Embark Planner (`EmbarkScene.ts`)

- Two tabs: **Create Dungeon** (player-authored), **Community Dungeons** (shared list).
- Players pick up to four heroes, filter community runs, and confirm supplies (pulled from `townStore` inventory).
- ESC closes the planner and resumes Town; TAB switches tabs.
- Launching a run stops TownScene and starts `Game` with a seed, hero snapshot payload, supply counts, and dungeon metadata.

### 3.3 Dungeon Exploration (`Game.ts`)

- Grid: `80 × 56` tiles at `16px` each, generated by `generateDungeon`.
- Systems live side-by-side:
  - Torch/light falloff via `TorchSystem` (E consumes torches if decision prompts allow).
  - Stress and inventory panels instantiate onto a dedicated UI layer.
  - Minimap tracks explored tiles and renders markers (chests, future portals).
  - Encounter prompt pauses movement with confirm/decline decisions tied into run state.
  - Loot chests spawn from `dun.chests`, random loot resolved client-side for now.
  - Party trail smoothed with vector history and follower spacing.
- Camera auto-resizes with viewport; additional resize hooks refresh minimap, prompts, and UI layout.
- Pending addition: random portal tiles (4–5 per dungeon) for early extraction.

### 3.4 Combat (`Combat.ts`)

- Loads only the spritesheets referenced by the run payload’s `UnitAssets`.
- Sets up four hero slots and four enemy slots, turn order, defend state, HUD with action menus, and target markers.
- ESC triggers a handler to exit combat (flow TBD when wiring to on-chain settlement).
- Emits `combatEnd` events which `Game` scene listens to for post-combat resolution (loot, stress, etc.).

---

## 4. Core Systems (Implemented & In-Progress)

### 4.1 Party & Hero Data

- Party order defaults to `PARTY_ORDER` but respects hero snapshots passed in from the Embark planner.
- `RunState` holds stress per hero and a 6-slot `Inventory`; JSON snapshots allow persistence between scenes.
- `townStore` backs long-lived roster, buildings, and community dungeon list; supports toast notifications.

### 4.2 Torch & Visibility

- Light influences encounter odds; darkness increases enemy chance and stress (logic stubbed for future tuning).
- Torch UI sits in HUD, and consuming torches is gated if the player is making an encounter decision.

### 4.3 Movement & Followers

- Leader speed: `3 tiles/sec` (scaled to pixels). Followers track a trail buffer (`trailMax = 3000`) for smooth movement.
- Leader facing swaps based on movement vector for sprite flipping.

### 4.4 Minimap

- `MinimapController` observes explored tiles, renders markers (circle/cross), and keeps position relative to window size.
- Resets when dungeon regenerates; handles responsive sizing up to 220×160 pixels.

### 4.5 Loot & Inventory

- Chests: random quantity of gold pouches and extra consumables (stress tonic, torch, salve, mystery relic).
- Loot modal blocks input until resolved, updates minimap markers, and writes to run inventory (`InventoryPanel.refresh()`).
- Discard/use actions are available inside the dungeon via inventory panel callbacks.

### 4.6 Encounters & Stress

- Distance traveled + torch level produce encounter rolls; cooldown prevents back-to-back fights.
- Encounter prompt UI (“Scout / Engage”) sits on HUD; resolution dispatches to Combat scene with generated enemy packs.
- Stress panel reflects `RunState` values, ready to integrate with combat outcomes and item usage.

---

## 5. On-Chain Direction & Economy

We are pivoting to a fully on-chain architecture without discarding the existing Phaser front-end.

### 5.1 Execution Model

- **Authoritative state:** Solana program(s) backed by MagicBlock Ephemeral Rollups (ERs). Dungeon runs delegate state to ERs for low-latency ticks, while the base layer remains the source of truth.
- **Client role:** Phaser client becomes a rich renderer and input surface; it gathers player actions, signs them, and submits to MagicBlock’s Router, which routes to ER or L1 as needed.
- **State sync:** Wallet-connected client listens for run updates, hero stress changes, loot claims, dungeon portal usage, and portal settlements emitted from ER commits.
- **Randomness:** Dungeon seeds, chest contents, portal placements, and encounter rolls use MagicBlock VRF. Local generation only mirrors confirmed on-chain randomness to keep rendering deterministic.

### 5.2 Assets & Tokens

- **Heroes:** ERC-721–like NFTs with class, stats, quirks. On death in a run, the NFT is burned and stress is irrelevant thereafter.
- **Consumables & loot:** ERC-1155 tokens; inventory slots map to fungible balances.
- **Gold:** Fungible token used for purchases and revenue sharing.

### 5.3 Dungeon NFTs & Revenue Share

- **Minting:** Players craft or curate a dungeon layout (seed + modifiers) and mint it as a Dungeon NFT.
- **Ownership:** The NFT stores metadata (seed, difficulty, author-defined modifiers, portal density, art theme).
- **Runtime selection:** Embark planner lists owned dungeons plus community dungeons (NFT holders can publish runs).
- **Revenue share:** When a player clears a run inside another player’s dungeon, 1% of the gold they extract is automatically diverted to the Dungeon NFT owner. Distribution happens during run settlement on-chain.
- **Failure clause:** If the entire party dies (all heroes at 0 HP) before reaching a portal, no gold is banked; therefore no revenue share is paid to the dungeon owner.
- **Secondary perks:** Future roadmap may allow owners to set optional modifiers (trap density, bonus loot) in exchange for higher/lower revenue splits.

### 5.4 Settlement Flow

1. Player signs the embark transaction specifying dungeon NFT ID, party, supplies. Instruction includes the PDA set that will be delegated (`RunSession`, `RunInventory`, `DungeonInstance`).
2. Program CPI-calls `delegate_account` from `ephemeral_rollups_sdk`, opening the ER session. Magic Router detects delegation and routes subsequent ticks to the ER endpoint.
3. Client streams actions (movement, torch use, combat commands) via `sendMagicTransaction`. ER validators execute, periodically calling `commit_accounts` so Town scene can read mid-run progress.
4. Portal usage (see §6) triggers a MagicBlock VRF-backed exit instruction: run loot is tallied, 99% routed to the delver, 1% to the dungeon NFT owner, stress updates committed, and `commit_and_undelegate_accounts` finalizes the session.
5. Full party death calls `commit_and_undelegate_accounts` with zero payout so the dungeon owner receives nothing.

### 5.5 MagicBlock Toolkit Alignment

- **Ephemeral Rollups SDK:** Provides `delegate_account`, `commit_accounts`, and `commit_and_undelegate_accounts` to manage run PDAs during high-frequency dungeon ticks.
- **Magic Router SDK:** Front-end uses router RPCs (e.g., `https://devnet-router.magicblock.app`) and `sendMagicTransaction` so transactions auto-route to ER or base layer.
- **VRF SDK:** `ephemeral_vrf_sdk` supplies randomness callbacks for dungeon seed, chest/portal placement, encounter tables, and rare item rolls.
- **Templates & examples:** Anchor counter + VRF dice demos from `docs/magicblocks/pages/templates` inform our reference client and contract patterns.

---

## 6. Dungeon Portals (New Feature)

We will introduce 4–5 exit portals per dungeon to let players bank their haul before facing the boss or delving deeper.

- **Placement logic:**
  - Derived from the same RNG stream used for chest placement to keep parity between client and chain.
  - Portals spawn on unique floor tiles, minimum distance from the entrance, and never overlap with chests or door tiles.
  - Quantity: random between 4 and 5 per run.
- **Interaction:**
  - When the leader is within 1 tile radius, prompt appears to _Exit Dungeon_.
  - Exiting triggers run settlement (see §5.4). Gold and items are finalized; party returns to TownScene with updated stress.
  - Portals are single-use per run; once used, they disappear.
- **UI hooks:**
  - Minimap markers (distinct color/shape) to help navigation.
  - World sprite similar to chests but glowing (new asset or tint).
  - Encounter flow pauses while portal prompt is active to avoid overlapping decisions.
- **On-chain representation:** Portal usage is an explicit action recorded in the run ledger so revenue share can execute deterministically.

---

## 7. Content & Progression Plan

### 7.1 Current Content

- Four base hero classes (per `HERO_SHEETS` & `HERO_ANIM_KEYS`) with idle/walk animations.
- Encounters pick from `ENEMY_ASSETS`.
- Town buildings exist visually; some effects (stress relief, blessing) are implemented through `townStore` actions.
- Inventory supports six slots, simple consumables, and basic loot generation.

### 7.2 Short-Term Enhancements

1. **Portal implementation:** spawn logic, sprites, prompts, minimap markers, settlement hook.
2. **Dungeon NFT integration:** Embark scene to fetch wallet-owned NFTs; community list pulls from chain indexer.
3. **Run settlement stub:** Mirror on-chain flow locally (stress/gold updates, revenue share simulation) to validate UX before smart contracts land.
4. **Combat rewards tuning:** Ensure loot and stress adjustments match the new economy (gold-only runs feed revenue share).
5. **Hero stress persistence:** Apply stress deltas from run back into `townStore` and eventually on-chain hero data.

### 7.3 Mid-Term Goals

- Multiplayer leaderboards referencing on-chain dungeon performance.
- Town upgrades gated by on-chain resource spends (blacksmith tiers, guild training).
- Visual polish: portal VFX, dungeon decorators, hero ability FX.
- Expand enemy roster and skill variety; align Combat HUD to new abilities.

### 7.4 Long-Term Vision

- Co-op support (shared runs, revenue splits).
- Dynamic dungeon modifiers tied to NFT metadata (seasonal curses, daily affixes).
- Deep integration of AI-driven lore/events once core on-chain mechanics stabilize.

---

## 8. Technical Architecture Overview

| Layer            | Responsibility                                             |
| ---------------- | ---------------------------------------------------------- |
| Phaser front-end | Input capture, rendering, HUD, deterministic previews.     |
| Magic Router     | Receives signed transactions and routes to ER or base layer automatically. |
| Client wallet    | Signs actions (embark, portal exit, item use).             |
| On-chain engine  | Validates movement/combat, updates hero/dungeon state, mints/burns assets, triggers revenue share via ER sessions. |
| VRF oracle       | Supplies verifiable randomness callbacks for seeds and loot. |
| Indexer/relay    | Streams dungeon NFTs, community runs, leaderboard stats.   |
| Asset pipeline   | Serves spritesheets, audio, shaders via Vite dev/prod.     |

- We will continue bundling with Vite; build warnings about chunk size are acceptable for now.
- `npm run dev` remains the local test command; on-chain mocks should plug into this loop without requiring full deployment.

---

## 9. Roadmap Snapshot

| Timeline | Focus                                                            |
| -------- | ---------------------------------------------------------------- |
| **Now**  | Implement portal system; surface dungeon NFT placeholders in Embark UI; update run settlement flow locally. |
| **Next** | Integrate wallet + on-chain APIs; wire 1% revenue share; migrate randomness to VRF-backed seeds. |
| **Later**| Expand combat depth, PvP modes, seasonal dungeon drops, analytics dashboards. |

---

## 10. Terminology Reference

- **Dungeon NFT:** Asset representing a specific dungeon seed/layout + metadata. Owner earns 1% of extracted gold from other players’ successful runs.
- **Portal:** Randomly placed extraction point allowing players to end a run without defeating the final boss.
- **Run State:** Aggregate of party stress, inventory, encounter progress, and minimap exploration for a single dungeon attempt.
- **Revenue Share Settlement:** On-chain transaction distributing loot between delver and dungeon owner.

---

This GDD should now be in sync with the codebase and provides the blueprint for making the prototype fully on-chain while layering in dungeon ownership economics and the new portal mechanic. Future edits should continue to track implementation realities and planned milestones. 
